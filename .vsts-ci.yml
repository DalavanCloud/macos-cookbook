---
resources:
- repo:                        self
  clean:                       true
variables:
  admin_password:              vagrant
queue:
  name:                        ApexInfra macOS
  parallel:                    18
  timeoutInMinutes:            120
  matrix:
    default-el-capitan-chef13:
      kitchen_suite:           default
      macos_version:           el-capitan
      chef_version:            chef13
steps:
- script:                      |
    export PATH=$PATH:/usr/local/bin
    eval "`/usr/local/bin/chef shell-init bash`"
    knife download /data_bags --chef-repo-path $(Build.SourcesDirectory) --no-color
  displayName:                 Download data bags
  failOnStderr:                false
  continueOnError:             false
- script:                      |
    export PATH=$PATH:/usr/local/bin
    eval "`/usr/local/bin/chef shell-init bash`"
    export VAGRANT_HOME=$(Agent.HomeDirectory)/../.vagrant.d/
    foodcritic . --exclude spec --epic-fail any --tags any
    cookstyle --extra-details --no-color
    rspec spec --no-color
  displayName:                 Verify
  failOnStderr:                false
  continueOnError:             false
- script:                      |
    export PATH=$PATH:/usr/local/bin
    eval "`/usr/local/bin/chef shell-init bash`"
    export VAGRANT_HOME=$(Agent.HomeDirectory)/../.vagrant.d/
    kitchen test $(kitchen_suite)-$(macos_version)-$(chef_version) --concurrency 1 --destroy always --no-color
  displayName:                 Acceptance
  failOnStderr:                false
  continueOnError:             false
